package smg:gateway;

interface middleware-types {
  record header { name: string, value: string }

  // onRequest (full body variant)
  record request {
    method: string,
    path: string,
    query: string,
    headers: list<header>,
    body: list<u8>,
    request-id: string,
    now-epoch-ms: u64,
  }

  // Headers-only request variant for streaming-compatible modules.
  // Modules that only need to inspect/modify headers use this to avoid body buffering.
  record request-headers {
    method: string,
    path: string,
    query: string,
    headers: list<header>,
    request-id: string,
    now-epoch-ms: u64,
  }

  // onResponse (full body variant)
  record response {
    status: u16,
    headers: list<header>,
    body: list<u8>,
  }

  // Headers-only response variant for streaming-compatible modules.
  record response-headers {
    status: u16,
    headers: list<header>,
  }

  // modify action
  record modify-action {
    status: option<u16>,
    headers-set: list<header>,
    headers-add: list<header>,
    headers-remove: list<string>,
    body-replace: option<list<u8>>,
  }

  // return actions
  variant action {
    continue,
    reject(u16), // status code
    modify(modify-action),
  }
}

interface middleware-on-request {
  use middleware-types.{request, action};
  on-request: func(req: request) -> action;
}

interface middleware-on-response {
  use middleware-types.{response, action};
  on-response: func(resp: response) -> action;
}

interface middleware-on-request-headers {
  use middleware-types.{request-headers, action};
  on-request-headers: func(req: request-headers) -> action;
}

interface middleware-on-response-headers {
  use middleware-types.{response-headers, action};
  on-response-headers: func(resp: response-headers) -> action;
}

world smg {
  export middleware-on-request;
  export middleware-on-response;
  export middleware-on-request-headers;
  export middleware-on-response-headers;
}
